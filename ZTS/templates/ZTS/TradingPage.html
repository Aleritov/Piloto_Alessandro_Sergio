{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}

{% endblock %}

{% block content %}
<!-- Contenido adaptado para móviles -->
<div id="temporizador" style="position:absolute; top:10px; right:20px; font-size:16px; color:#444;">
    Tiempo restante del periodo: <span id="timer">25</span>
</div>

<div class="container p-3">
    <div class="row">

        <!-- Noticias y operaciones -->
        <div class="col-12 col-lg-5 mb-4" style="background-color:rgb(240,240,240); border-radius: 12px; padding: 15px;">
            <div class="noticia mb-4">
                <h4>Noticias</h4>
                <p id="trade_news"></p>
            </div>

            <div class="mb-4">
                <h4>Operación</h4>
                <div class="d-flex flex-wrap gap-2 justify-content-between">
                    <button onclick="buy_shares(this.value)" value="1" id="trade_btn_buy_s" class="btn btn-primary flex-fill m-1">Comprar 1</button>
                    <button onclick="buy_shares(this.value)" value="10" id="trade_btn_buy_m" class="btn btn-primary flex-fill m-1">Comprar 10</button>
                    <button onclick="buy_shares(this.value)" value="20" id="trade_btn_buy_l" class="btn btn-primary flex-fill m-1">Comprar 20</button>
                    <button onclick="sell_shares(this.value)" value="1" id="trade_btn_sell_s" class="btn btn-danger flex-fill m-1">Vender 1</button>
                    <button onclick="sell_shares(this.value)" value="10" id="trade_btn_sell_m" class="btn btn-danger flex-fill m-1">Vender 10</button>
                    <button onclick="sell_shares(this.value)" value="20" id="trade_btn_sell_l" class="btn btn-danger flex-fill m-1">Vender 20</button>
                </div>
                <h5 class="text-center mt-3">Precio actual:</h5>
                <h2 class="text-center" id="trade_price"></h2>
            </div>
        </div>

        <!-- Gráfico de mercado -->
        <div class="col-12 col-lg-7" style="background-color:rgb(240,240,240); border-radius: 12px; padding: 15px;">
            <h4>Mercado</h4>
            <div style="width: 100%; overflow-x: auto;">
                <div id="container" style="min-width: 300px; height: 200px;"></div>
            </div>
        </div>
    </div>

    <!-- Portafolio -->
    <div class="row mt-4">
        <div class="col-12">
            <h4>Mi Portafolio</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Efectivo</th>
                        <th>Acciones</th>
                        <th>Valor en acciones</th>
                        <th>Valor del portafolio</th>
                        <th>Ganancia/Pérdida acumulada</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="table_cash"></td>
                        <td id="table_shares"></td>
                        <td id="table_share_value"></td>
                        <td id="table_total"></td>
                        <td id="table_pandl"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% next_button %}
{% endblock %}

{% block scripts %}
<!-- Scripts -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<body onkeydown="return (event.keyCode != 116)"></body>
<body onkeydown="return (event.keyCode != 8)"></body>
<body onkeydown="return (event.keyCode != 123)"></body>
<body onkeydown="return (event.keyCode != 154)"></body>

<script src="{% static "ZTS/chart.js" %}"></script>
<script src="{% static "ZTS/trade_controller.js" %}"></script>

<script>
    const refreshRateMs = js_vars.refresh_rate;
    const refreshRateSec = Math.floor(refreshRateMs / 1000);
    let countdown = refreshRateSec;
    const timerDisplay = document.getElementById('timer');

    function updateCountdown() {
        if (countdown > 0) {
            timerDisplay.textContent = countdown + ' segundos';
            countdown--;
        } else {
            countdown = refreshRateSec;
            timerDisplay.textContent = countdown + ' segundos';
            countdown--;
        }
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
</script>
{% endblock %}

{% block styles %}
<style>
    .noticia {
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 8px;
        font-size: 16px;
        line-height: 1.4;
    }
    .gap-2 {
        gap: 10px !important;
    }
</style>
{% endblock %}
